name: Cargo Build & Test

on:
  push:
  pull_request:
    types:
      - opened
      - reopened
      - ready_for_review

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - macos-latest
          - ubuntu-latest
          - windows-latest

        target:
          - x86_64-unknown-linux-gnu
          - x86_64-apple-darwin
          - aarch64-apple-darwin
          - x86_64-pc-windows-msvc

        toolchain:
          - stable

        feature_bundle:
          - bundle-default
          - bundle-sdk

        feature_target:
          - target-c-lib
          - target-cli
          - target-java-lib
          - target-wasm

        exclude:
          # Don't test linux/windows targets on macos
          - os: macos-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: x86_64-pc-windows-msvc
          # Don't test darwin/windows targets on ubuntu
          - os: ubuntu-latest
            target: x86_64-apple-darwin
          - os: ubuntu-latest
            target: aarch64-apple-darwin
          - os: ubuntu-latest
            target: x86_64-pc-windows-msvc
          # Don't test darwin/linux targets on windows
          - os: windows-latest
            target: x86_64-apple-darwin
          - os: windows-latest
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-unknown-linux-gnu

    steps:
      - uses: actions/checkout@v2

      - uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ matrix.toolchain }}
          components: rustfmt, clippy
          target: ${{ matrix.target }}
          override: true

      - run: rustup target add ${{ matrix.target }}

      - name: Install clang for ubuntu
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
               sudo apt install -y clang
          fi
        shell: bash

      - name: Install wasm-pack
        if: ${{ matrix.feature_target == 'target-wasm'}}
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WASM file with wasm-pack
        if: ${{ matrix.feature_target == 'target-wasm'}}
        run: wasm-pack build --release --target web -- --no-default-features --features=${{ matrix.feature_bundle }},${{ matrix.feature_target }}

      - name: Build binaries
        if: ${{ matrix.feature_target != 'target-wasm'}}
        run: cargo build --release --target=${{ matrix.target }} --no-default-features --features=${{ matrix.feature_bundle }},${{ matrix.feature_target }}

      - name: Run tests
        run: cargo test --verbose
